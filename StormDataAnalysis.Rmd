---
title: "Population Health Impact and Economic Consequences of Storms"
author: "Ben Kesseler"
date: "May 18, 2016"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***

# Synopsis
This report examines the U.S. National Oceanic and Atmospheric Administration's 
(NOAA) storm database, finding _____________. All analysis was performed at the
national level, ignoring specific locations. Individual "events" are not easily
determined to assess impacts per "event", so impacts are considered in aggregate
over time.

***

# Data Processing

## Loading the Raw Data

Library packages are loaded for the entire analysis. Code output has been
suppressed for this code only.

```{r libraries, results = 'hide'}
libraries <- c("ggplot2",
               "knitr",
               "tools",
               "readr",
               "scales",
               "lubridate",
               "pander"
               )
sapply(libraries, library, character.only = TRUE)
```

We start with the [NOAA Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)
that is archived on the course website and documented [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) and [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf).

```{r dataimport, cache = TRUE}
source_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
target_local_archive <- "storm_data.csv.bz2"

if (!file.exists(target_local_archive)) {
  download.file(source_url,target_local_archive)
}

storm_data <- read_csv(target_local_archive, na = "NA")
```

***

## Initial Cleaning

Each row is a very detailed description of a location, event type, and damage,
if any. Actual logical events such as a regional storm or other weather impact 
might entail many rows, and there is no obvious way to usefully aggregate the 
rows to logical events.

The analysis covers the entire United States, so location is not important.

As a result, the data will be aggregated by event type at the year level. This 
will allow the analysis to calculate the impact at an annual level if needed,
and across the entire time period for the main analysis.

Once the data is loaded from the .csv.bz2 file, I keep only the year, event
type, fatalities, injuries, property damage, and crop damage.

I convert the economic impacts into a consistent scale. I'm unsure of the 
meaning of non-standard exponents in the data, so I'm treating them as 1, after 
documenting their prevalence.

```{r datacleaning}
storm_data_cleaned <- storm_data[, c("BGN_DATE",
                                     "EVTYPE",
                                     "FATALITIES",
                                     "INJURIES",
                                     "PROPDMG",
                                     "PROPDMGEXP",
                                     "CROPDMG",
                                     "CROPDMGEXP"
                                     )
                                 ]

colnames(storm_data_cleaned) <- c("BGN_DATE",
                                  "event_type",
                                  "fatalities",
                                  "injuries",
                                  "property_damage",
                                  "property_damage_exponent",
                                  "crop_damage",
                                  "crop_damage_exponent"
                                  )

storm_data_cleaned$year <- year(as.POSIXct(storm_data_cleaned$BGN_DATE,
                                           format = "%m/%d/%Y"))

mappable_exponents_property <- sum(storm_data_cleaned$property_damage_exponent == "B") +
                               sum(storm_data_cleaned$property_damage_exponent == "M") +
                               sum(storm_data_cleaned$property_damage_exponent == "K") +
                               sum(storm_data_cleaned$property_damage_exponent == "")

mappable_exponents_crop <- sum(storm_data_cleaned$crop_damage_exponent == "B") +
                           sum(storm_data_cleaned$crop_damage_exponent == "M") +
                           sum(storm_data_cleaned$crop_damage_exponent == "K") +
                           sum(storm_data_cleaned$crop_damage_exponent == "")

percent_unmappable_property <- 1 - mappable_exponents_property / nrow(storm_data_cleaned)

percent_unmappable_crop <- 1 - mappable_exponents_crop / nrow(storm_data_cleaned)

print(paste(percent(percent_unmappable_property),
            "of property damage records have unmappable exponents"))

print(paste(percent(percent_unmappable_crop),
            "of crop damage records have unmappable exponents"))
```

Those are a very small percent of the records, so treating them as 1 should be
reasonable.

***

I now convert things to a consistent numeric scale, so summation functions will
work.

```{r datacleaning2}
scalar_mapping <- data.frame("property_damage_exponent" = c("B","M","K"),
                             "property_damage_numeric_exponent" = c(1000000000,
                                                                    1000000,
                                                                    1000),
                             "crop_damage_exponent" = c("B","M","K"),
                             "crop_damage_numeric_exponent" = c(1000000000,
                                                                1000000,
                                                                1000)
                            )

storm_data_cleaned <- merge(storm_data_cleaned,
                            scalar_mapping[, 
                                           c("property_damage_exponent",
                                             "property_damage_numeric_exponent"
                                            )
                                          ],
                            all.x = TRUE)
storm_data_cleaned$property_damage_numeric_exponent[
  is.na(storm_data_cleaned$property_damage_numeric_exponent)
  ] <- 1

storm_data_cleaned <- merge(storm_data_cleaned,
                            scalar_mapping[, 
                                           c("crop_damage_exponent",
                                             "crop_damage_numeric_exponent"
                                            )
                                          ],
                            all.x = TRUE)
storm_data_cleaned$crop_damage_numeric_exponent[
  is.na(storm_data_cleaned$crop_damage_numeric_exponent)
  ] <- 1

storm_data_cleaned$property_damage <- storm_data_cleaned$property_damage * 
                                      storm_data_cleaned$property_damage_numeric_exponent

storm_data_cleaned$crop_damage <- storm_data_cleaned$crop_damage * 
                                  storm_data_cleaned$crop_damage_numeric_exponent

storm_data_cleaned$economic_damage <- storm_data_cleaned$property_damage + 
                                      storm_data_cleaned$crop_damage
```

## Data Aggregation

Now I will summarize the data at the level needed for plotting and further
exploration - annual by event type.

```{r dataaggregation}
storm_data_cleaned <- storm_data_cleaned[, c("year",
                                             "event_type",
                                             "fatalities",
                                             "injuries",
                                             "economic_damage")]

storm_data_summary <- aggregate(. ~ year + event_type,
                                data = storm_data_cleaned,
                                FUN = sum)

storm_data_count <- aggregate(fatalities ~ year + event_type,
                              data = storm_data_cleaned,
                              FUN = length)

storm_data_summary <- cbind(storm_data_summary,storm_data_count$fatalities)

storm_data_summary$count <- storm_data_count$fatalities

count_by_year <- aggregate(count ~ year, data = storm_data_summary, FUN = sum)

# panderOptions("table.alignment.default","left")
# pander(count_by_year)
```

It looks like there is a marked increase in the number of events in 1995. I am
concerned that data from previous years doesn't accurately represent the
distribution of event types, so I am restricting the analysis to 1995 and
forward.

## Event Type Clean-up

Here I will summarize the data by event_type, for the years 1995 and after, and
I will remove event types that have no fatalities, injuries, or economic damage,
and begin cleaning event types.

```{r datasubsetting}
storm_data_summary <- storm_data_summary[storm_data_summary$year >= 1995, ]

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary[, c("event_type",
                                                              "fatalities",
                                                              "injuries",
                                                              "economic_damage")
                                                          ],
                                FUN = sum)

storm_data_summary <- storm_data_summary[storm_data_summary$fatalities > 0 |
                                           storm_data_summary$injuries > 0 |
                                           storm_data_summary$economic_damage > 0
                                         , ]

storm_data_summary$event_type <- tolower(storm_data_summary$event_type)

storm_data_summary$event_type <- gsub("[^a-zA-Z0-9]","",storm_data_summary$event_type)

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary,
                                FUN = sum)

# panderOptions("table.alignment.default","left")
# pander(storm_data_summary)
```

***

Now I'm going to clean up some of the obvious event_types errors.

```{r textreplacement}
storm_data_summary$event_type[
  storm_data_summary$event_type == "coastalflood"
  ] <- "coastalflooding"

storm_data_summary$event_type[
  storm_data_summary$event_type == "erosioncstlflood"
  ] <- "coastalfloodingerosion"

storm_data_summary$event_type[
  storm_data_summary$event_type == "flashfloodflood"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "flashflooding"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "flashfloods"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "flashfloodstreet"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "floodflash"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "floodflashflood"
  ] <- "flashflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "flooding"
  ] <- "flood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "floods"
  ] <- "flood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "floodingheavyrain"
  ] <- "floodheavyrain"

storm_data_summary$event_type[
  storm_data_summary$event_type == "gustywinds"
  ] <- "gustywind"

storm_data_summary$event_type[
  grep("^hail", storm_data_summary$event_type)
  ] <- "hail"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heatwave"
  ] <- "heat"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavyrains"
  ] <- "heavyrain"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavyrainsevereweather"
  ] <- "heavyrain"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavysnowandstrongwinds"
  ] <- "heavysnowandhighwinds"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavysnowshower"
  ] <- "heavysnow"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavysnowsqualls"
  ] <- "heavysnow"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavysurfhighsurf"
  ] <- "highsurf"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavysurf"
  ] <- "highsurf"

storm_data_summary$event_type[
  storm_data_summary$event_type == "heavyswells"
  ] <- "highswells"

storm_data_summary$event_type[
  storm_data_summary$event_type == "highwinddamage"
  ] <- "highwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "highwindg40"
  ] <- "highwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "highwinds"
  ] <- "highwind"

storm_data_summary$event_type[
  grep("^hurricane", storm_data_summary$event_type)
  ] <- "hurricane"

storm_data_summary$event_type[
  storm_data_summary$event_type == "hvyrain"
  ] <- "heavyrain"

storm_data_summary$event_type[
  storm_data_summary$event_type == "icejamfloodminor"
  ] <- "icejamflooding"

storm_data_summary$event_type[
  storm_data_summary$event_type == "iceonroad"
  ] <- "icyroads"

storm_data_summary$event_type[
  storm_data_summary$event_type == "iceroads"
  ] <- "icyroads"

storm_data_summary$event_type[
  storm_data_summary$event_type == "landslides"
  ] <- "landslide"

storm_data_summary$event_type[
  storm_data_summary$event_type == "lightninginjury"
  ] <- "lightning"

storm_data_summary$event_type[
  storm_data_summary$event_type == "lightsnowfall"
  ] <- "lightsnow"

storm_data_summary$event_type[
  storm_data_summary$event_type == "marinehighwind"
  ] <- "marinestrongwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "marinetstmwind"
  ] <- "marinethunderstormwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "mixedprecip"
  ] <- "mixedprecipitation"

storm_data_summary$event_type[
  storm_data_summary$event_type == "mudslides"
  ] <- "mudslide"

storm_data_summary$event_type[
  storm_data_summary$event_type == "ripcurrents"
  ] <- "ripcurrent"

storm_data_summary$event_type[
  storm_data_summary$event_type == "riverandstreamflood"
  ] <- "riverflooding"

storm_data_summary$event_type[
  storm_data_summary$event_type == "riverflood"
  ] <- "riverflooding"

storm_data_summary$event_type[
  storm_data_summary$event_type == "severethunderstorm"
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "severethunderstorms"
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "severethunderstormwinds"
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "thunerstormwinds"
  ] <- "thunderstorm"

storm_data_summary$event_type[
  grep("^thunderstorm", storm_data_summary$event_type)
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "strongwinds"
  ] <- "strongwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "stormforcewinds"
  ] <- "strongwind"

storm_data_summary$event_type[
  storm_data_summary$event_type == "stormsurgetide"
  ] <- "stormsurge"

storm_data_summary$event_type[
  storm_data_summary$event_type == "snowsquall"
  ] <- "snow"

storm_data_summary$event_type[
  storm_data_summary$event_type == "snowsqualls"
  ] <- "snow"

storm_data_summary$event_type[
  storm_data_summary$event_type == "snowice"
  ] <- "snowandice"

storm_data_summary$event_type[
  storm_data_summary$event_type == "smallhail"
  ] <- "hail"

storm_data_summary$event_type[
  grep("^tornado", storm_data_summary$event_type)
  ] <- "tornado"

storm_data_summary$event_type[
  grep("^tropicalstorm", storm_data_summary$event_type)
  ] <- "tropicalstorm"

storm_data_summary$event_type[
  grep("^tstmwind", storm_data_summary$event_type)
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "tunderstormwind"
  ] <- "thunderstorm"

storm_data_summary$event_type[
  storm_data_summary$event_type == "unseasonablecold"
  ] <- "unseasonablycold"

storm_data_summary$event_type[
  storm_data_summary$event_type == "urbanandsmallstreamfloodin"
  ] <- "urbanflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "urbanflooding"
  ] <- "urbanflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "urbansmallstreamflood"
  ] <- "urbanflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "urbansmlstreamfld"
  ] <- "urbanflood"

storm_data_summary$event_type[
  storm_data_summary$event_type == "waterspouttornado"
  ] <- "waterspout"

storm_data_summary$event_type[
  storm_data_summary$event_type == "wildfires"
  ] <- "wildfire"

storm_data_summary$event_type[
  storm_data_summary$event_type == "wildforestfires"
  ] <- "wildforestfire"

storm_data_summary$event_type[
  storm_data_summary$event_type == "winds"
  ] <- "wind"

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary,
                                FUN = sum)
```

Alright, that's as much cleaning as can reasonably be done. Now to look at the 
top sources of fatalities, injuries, and economic damage.

***

## Top 20 Fatality, Injury, and Economic Damage Sources

I will determine the top 20 event types for causing fatalities + injuries and 
separately for causing economic damage.