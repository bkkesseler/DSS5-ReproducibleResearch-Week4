---
title: "Population Health Impact and Economic Consequences of Storms"
author: "Ben Kesseler"
date: "May 18, 2016"
output: html_document
---

<style type="text/css">

th, td {  /* Table  */
   font-size: 10px;
}
</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***

# Synopsis
This report examines the U.S. National Oceanic and Atmospheric Administration's 
(NOAA) storm database, finding _____________. All analysis was performed at the
national level, ignoring specific locations. Individual "events" are not easily
determined to assess impacts per "event", so impacts are considered in aggregate
over time.

***

# Data Processing

## Loading the Raw Data

Library packages are loaded for the entire analysis. Code output has been
suppressed for this code only.

```{r libraries, results = 'hide', message = FALSE}
libraries <- c("ggplot2",
               "knitr",
               "tools",
               "readr",
               "scales",
               "lubridate",
               "pander"
               )
sapply(libraries, library, character.only = TRUE)
```

We start with the [NOAA Storm Data](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)
that is archived on the course website and documented [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) and [here](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf).

```{r dataimport, cache = TRUE}
source_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
target_local_archive <- "storm_data.csv.bz2"

if (!file.exists(target_local_archive)) {
  download.file(source_url,target_local_archive)
}

storm_data <- read_csv(target_local_archive, na = "NA")
```

***

## Initial Cleaning

Each row is a very detailed description of a location, event type, and damage,
if any. Actual logical events such as a regional storm or other weather impact 
might entail many rows, and there is no obvious way to usefully aggregate the 
rows to logical events.

The analysis covers the entire United States, so location is not important.

As a result, the data will be aggregated by event type at the year level. This 
will allow the analysis to calculate the impact at an annual level if needed,
and across the entire time period for the main analysis.

Once the data is loaded from the .csv.bz2 file, I keep only the year, event
type, fatalities, injuries, property damage, and crop damage.

I convert the economic impacts into a consistent scale. I'm unsure of the 
meaning of non-standard exponents in the data, so I'm treating them as 1, after 
documenting their prevalence.

```{r datacleaning}
storm_data_cleaned <- storm_data[, c("BGN_DATE",
                                     "EVTYPE",
                                     "FATALITIES",
                                     "INJURIES",
                                     "PROPDMG",
                                     "PROPDMGEXP",
                                     "CROPDMG",
                                     "CROPDMGEXP"
                                     )
                                 ]

colnames(storm_data_cleaned) <- c("BGN_DATE",
                                  "event_type",
                                  "fatalities",
                                  "injuries",
                                  "property_damage",
                                  "property_damage_exponent",
                                  "crop_damage",
                                  "crop_damage_exponent"
                                  )

storm_data_cleaned$year <- year(as.POSIXct(storm_data_cleaned$BGN_DATE,
                                           format = "%m/%d/%Y"))

mappable_exponents_property <- sum(storm_data_cleaned$property_damage_exponent == "B") +
                               sum(storm_data_cleaned$property_damage_exponent == "M") +
                               sum(storm_data_cleaned$property_damage_exponent == "K") +
                               sum(storm_data_cleaned$property_damage_exponent == "")

mappable_exponents_crop <- sum(storm_data_cleaned$crop_damage_exponent == "B") +
                           sum(storm_data_cleaned$crop_damage_exponent == "M") +
                           sum(storm_data_cleaned$crop_damage_exponent == "K") +
                           sum(storm_data_cleaned$crop_damage_exponent == "")

percent_unmappable_property <- 1 - mappable_exponents_property / nrow(storm_data_cleaned)

percent_unmappable_crop <- 1 - mappable_exponents_crop / nrow(storm_data_cleaned)
```

So `r percent(percent_unmappable_property)` of property damage records have
unmappable exponents, and `r percent(percent_unmappable_crop)` of crop damage
records have unmappable exponents. That's a very small percent of the records, 
so treating them as 1 should be reasonable.

***

I now convert things to a consistent numeric scale, so summation functions will
work properly.

```{r datacleaning2}
scalar_mapping <- data.frame("property_damage_exponent" = c("B","M","K"),
                             "property_damage_numeric_exponent" = c(1000000000,
                                                                    1000000,
                                                                    1000),
                             "crop_damage_exponent" = c("B","M","K"),
                             "crop_damage_numeric_exponent" = c(1000000000,
                                                                1000000,
                                                                1000)
                            )

storm_data_cleaned <- merge(storm_data_cleaned,
                            scalar_mapping[, 
                                           c("property_damage_exponent",
                                             "property_damage_numeric_exponent"
                                            )
                                          ],
                            all.x = TRUE)
storm_data_cleaned$property_damage_numeric_exponent[
  is.na(storm_data_cleaned$property_damage_numeric_exponent)
  ] <- 1

storm_data_cleaned <- merge(storm_data_cleaned,
                            scalar_mapping[, 
                                           c("crop_damage_exponent",
                                             "crop_damage_numeric_exponent"
                                            )
                                          ],
                            all.x = TRUE)
storm_data_cleaned$crop_damage_numeric_exponent[
  is.na(storm_data_cleaned$crop_damage_numeric_exponent)
  ] <- 1

storm_data_cleaned$property_damage <- storm_data_cleaned$property_damage * 
                                      storm_data_cleaned$property_damage_numeric_exponent

storm_data_cleaned$crop_damage <- storm_data_cleaned$crop_damage * 
                                  storm_data_cleaned$crop_damage_numeric_exponent

storm_data_cleaned$economic_damage <- storm_data_cleaned$property_damage + 
                                      storm_data_cleaned$crop_damage
```

## Data Aggregation

Now I will summarize the data at the level needed for plotting and further
exploration - annual by event type.

```{r dataaggregation}
storm_data_cleaned <- storm_data_cleaned[, c("year",
                                             "event_type",
                                             "fatalities",
                                             "injuries",
                                             "economic_damage")]

storm_data_summary <- aggregate(. ~ year + event_type,
                                data = storm_data_cleaned,
                                FUN = sum)

storm_data_count <- aggregate(fatalities ~ year + event_type,
                              data = storm_data_cleaned,
                              FUN = length)

storm_data_summary <- cbind(storm_data_summary,storm_data_count$fatalities)

storm_data_summary$count <- storm_data_count$fatalities

count_by_year <- aggregate(count ~ year, data = storm_data_summary, FUN = sum)

count_by_year_table <- data.frame("year1" = count_by_year[1:16, 1], 
                                  "event_count1" = count_by_year[1:16, 2],
                                  "year2" = count_by_year[17:32, 1],
                                  "event_count2" = count_by_year[17:32, 2],
                                  "year3" = count_by_year[33:48, 1],
                                  "event_count3" = count_by_year[33:48, 2],
                                  "year4" = c(count_by_year[49:62, 1], "", ""),
                                  "event_count4" = c(count_by_year[49:62, 2], "", "")
)

panderOptions("table.alignment.default","left")
panderOptions("table.split.table",Inf)
pander(count_by_year_table)
```

It looks like there is a marked increase in the number of events in 1995. I am
concerned that data from previous years doesn't accurately represent the
distribution of event types, so I am restricting the analysis to 1995 and
forward.

## Event Type Clean-up

Here I will summarize the data by event_type, for the years 1995 and after, and
I will remove event types that have no fatalities, injuries, or economic damage,
and begin cleaning event types.

```{r datasubsetting}
storm_data_summary <- storm_data_summary[storm_data_summary$year >= 1995, ]

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary[, c("event_type",
                                                              "count",
                                                              "fatalities",
                                                              "injuries",
                                                              "economic_damage")
                                                          ],
                                FUN = sum)

storm_data_summary <- storm_data_summary[storm_data_summary$fatalities > 0 |
                                         storm_data_summary$injuries > 0 |
                                         storm_data_summary$economic_damage > 0
                                         , ]

storm_data_summary$event_type <- tolower(storm_data_summary$event_type)

storm_data_summary$event_type <- gsub("[^a-zA-Z0-9]","",storm_data_summary$event_type)

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary,
                                FUN = sum)

storm_data_summary$event_match[storm_data_summary$event_type == "astronomicallowtide"]    <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "avalanche"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "blizzard"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "coastalflood"]           <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "coldwindchill"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "debrisflow"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "densefog"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "densesmoke"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "drought"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "dustdevil"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "duststorm"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "excessiveheat"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "extremecoldwindchill"]   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "flashflood"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "flood"]                  <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "frostfreeze"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "funnelcloud"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "freezingfog"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "hail"]                   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heat"]                   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heavyrain"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heavysnow"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "highsurf"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "highwind"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "hurricanetyphoon"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "icestorm"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lakeeffectsnow"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lakeshoreflood"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lightning"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinehail"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinehighwind"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinestrongwind"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinethunderstormwind"] <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "ripcurrent"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "seiche"]                 <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "sleet"]                  <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "stormsurgetide"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "strongwind"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "thunderstormwind"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tornado"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tropicaldepression"]     <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tropicalstorm"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tsunami"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "volcanicash"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "waterspout"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "wildfire"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "winterstorm"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "winterweather"]          <- 1

storm_data_summary$event_match[is.na(storm_data_summary$event_match)] <- 0

initial_matching <- aggregate(. ~ event_match,
                              data = storm_data_summary[, -1],
                              FUN = sum)

percent_unmatched_count <- initial_matching$count[initial_matching$event_match == 0] / 
  sum(initial_matching$count)

percent_unmatched_injuries <- initial_matching$injuries[initial_matching$event_match == 0] / 
  sum(initial_matching$injuries)

percent_unmatched_fatalities <- initial_matching$fatalities[initial_matching$event_match == 0] / 
  sum(initial_matching$fatalities)

percent_unmatched_economic_damage <- initial_matching$economic_damage[initial_matching$event_match == 0] / 
  sum(initial_matching$economic_damage)

```

After minimal text formatting, I find that when comparing to the expected 48
event types, I'm unable to match `r percent(percent_unmatched_count)`
of the non-zero events, which account for `r percent(percent_unmatched_economic_damage)`
of the economic damage, `r percent(percent_unmatched_injuries)` of the injuries,
and `r percent(percent_unmatched_fatalities)` of the fatalities.

This clearly needs some work.

***

What event types remain?

``` {r cleanup}
event_type_list <- data.frame("event_type" = storm_data_summary[1:77, 1],
                              "event_type2" = storm_data_summary[78:154, 1],
                              "event_type3" = storm_data_summary[155:231, 1],
                              "event_type4" = c(storm_data_summary[232:307, 1], ""))

panderOptions("table.alignment.default", "left")
panderOptions("table.split.table",Inf)
pander(event_type_list)
```

***

Now I'm going to clean up some of the obvious event_types errors.

```{r textreplacement}
storm_data_summary$event_type[grep("^coastalflood", storm_data_summary$event_type)] <- "coastalflood"
storm_data_summary$event_type[storm_data_summary$event_type == "erosioncstlflood"] <- "coastalflood"
storm_data_summary$event_type[storm_data_summary$event_type == "tidalflooding"] <- "coastalflood"

storm_data_summary$event_type[storm_data_summary$event_type == "extendedcold"] <- "coldwindchill"
storm_data_summary$event_type[grep("^cold", storm_data_summary$event_type)] <- "coldwindchill"
storm_data_summary$event_type[storm_data_summary$event_type == "recordcold"] <- "coldwindchill"

storm_data_summary$event_type[storm_data_summary$event_type == "fog"] <- "densefog"

storm_data_summary$event_type[storm_data_summary$event_type == "droughtexcessiveheat"] <- "drought"

storm_data_summary$event_type[storm_data_summary$event_type == "dustdevilwaterspout"] <- "dustdevil"

storm_data_summary$event_type[storm_data_summary$event_type == "extremecold"] <- "extremecoldwindchill"
storm_data_summary$event_type[storm_data_summary$event_type == "extremewindchill"] <- "extremecoldwindchill"

storm_data_summary$event_type[grep("^flashflood", storm_data_summary$event_type)] <- "flashflood"
storm_data_summary$event_type[grep("^floodflash", storm_data_summary$event_type)] <- "flashflood"
storm_data_summary$event_type[storm_data_summary$event_type == "rapidlyrisingwater"] <- "flashflood"

storm_data_summary$event_type[grep("^flood", storm_data_summary$event_type)] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "breakupflooding"] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "riverandstreamflood"] <- "flood"
storm_data_summary$event_type[grep("^riverflood", storm_data_summary$event_type)] <- "flood"
storm_data_summary$event_type[grep("^urbanflood", storm_data_summary$event_type)] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "urbanandsmallstreamfloodin"] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "urbansmallstreamflood"] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "urbansmlstreamfld"] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "mudslidesurbanflooding"] <- "flood"
storm_data_summary$event_type[storm_data_summary$event_type == "ruralflood"] <- "flood"

storm_data_summary$event_type[grep("freeze$", storm_data_summary$event_type)] <- "frostfreeze"
storm_data_summary$event_type[grep("frost$", storm_data_summary$event_type)] <- "frostfreeze"

storm_data_summary$event_type[grep("^hail", storm_data_summary$event_type)] <- "hail"
storm_data_summary$event_type[storm_data_summary$event_type == "gustywindhail"] <- "hail"
storm_data_summary$event_type[storm_data_summary$event_type == "smallhail"] <- "hail"

storm_data_summary$event_type[grep("^heat", storm_data_summary$event_type)] <- "heat"
storm_data_summary$event_type[storm_data_summary$event_type == "recordheat"] <- "heat"
storm_data_summary$event_type[storm_data_summary$event_type == "warmweather"] <- "heat"

storm_data_summary$event_type[grep("^heavyrain", storm_data_summary$event_type)] <- "heavyrain"
storm_data_summary$event_type[storm_data_summary$event_type == "hvyrain"] <- "heavyrain"
storm_data_summary$event_type[storm_data_summary$event_type == "excessiverainfall"] <- "heavyrain"
storm_data_summary$event_type[storm_data_summary$event_type == "torrentialrainfall"] <- "heavyrain"

storm_data_summary$event_type[grep("^heavysnow", storm_data_summary$event_type)] <- "heavysnow"
storm_data_summary$event_type[grep("^snow", storm_data_summary$event_type)] <- "heavysnow"
storm_data_summary$event_type[storm_data_summary$event_type == "excessivesnow"] <- "heavysnow"

storm_data_summary$event_type[grep("^heavysurf", storm_data_summary$event_type)] <- "highsurf"
storm_data_summary$event_type[grep("^highsurf", storm_data_summary$event_type)] <- "highsurf"
storm_data_summary$event_type[storm_data_summary$event_type == "hazardoussurf"] <- "highsurf"

storm_data_summary$event_type[storm_data_summary$event_type == "heavyswells"] <- "highswells"

storm_data_summary$event_type[grep("^highwind", storm_data_summary$event_type)] <- "highwind"
storm_data_summary$event_type[grep("^gustywind", storm_data_summary$event_type)] <- "highwind"

storm_data_summary$event_type[grep("^hurricane", storm_data_summary$event_type)] <- "hurricanetyphoon"
storm_data_summary$event_type[storm_data_summary$event_type == "typhoon"] <- "hurricanetyphoon"

storm_data_summary$event_type[storm_data_summary$event_type == "icejamfloodminor"] <- "icejamflooding"
storm_data_summary$event_type[storm_data_summary$event_type == "iceonroad"] <- "icyroads"
storm_data_summary$event_type[storm_data_summary$event_type == "iceroads"] <- "icyroads"

storm_data_summary$event_type[storm_data_summary$event_type == "lakeflood"] <- "lakeshoreflood"

storm_data_summary$event_type[storm_data_summary$event_type == "landslides"] <- "landslide"

storm_data_summary$event_type[storm_data_summary$event_type == "lightsnowfall"] <- "lightsnow"

storm_data_summary$event_type[grep("^lightning", storm_data_summary$event_type)] <- "lightning"
storm_data_summary$event_type[storm_data_summary$event_type == "ligntning"] <- "lightning"

storm_data_summary$event_type[storm_data_summary$event_type == "marinetstmwind"] <- "marinethunderstormwind"

storm_data_summary$event_type[storm_data_summary$event_type == "mixedprecip"] <- "mixedprecipitation"

storm_data_summary$event_type[storm_data_summary$event_type == "mudslides"] <- "mudslide"

storm_data_summary$event_type[grep("^ripcurrent", storm_data_summary$event_type)] <- "ripcurrent"

storm_data_summary$event_type[storm_data_summary$event_type == "stormsurge"] <- "stormsurgetide"

storm_data_summary$event_type[storm_data_summary$event_type == "strongwinds"] <- "strongwind"
storm_data_summary$event_type[storm_data_summary$event_type == "stormforcewinds"] <- "strongwind"
storm_data_summary$event_type[storm_data_summary$event_type == "gustywinds"] <- "strongwind"
storm_data_summary$event_type[storm_data_summary$event_type == "icestrongwinds"] <- "strongwind"

storm_data_summary$event_type[grep("^thunderstorm", storm_data_summary$event_type)] <- "thunderstormwind"
storm_data_summary$event_type[grep("^tstmwind", storm_data_summary$event_type)] <- "thunderstormwind"
storm_data_summary$event_type[grep("^severethunderstorm", storm_data_summary$event_type)] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "thunerstormwinds"] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "thunderstormwins"] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "tunderstormwind"] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "thundeerstormwinds"] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "thunderestormwinds"] <- "thunderstormwind"
storm_data_summary$event_type[storm_data_summary$event_type == "thundertormwinds"] <- "thunderstormwind"

storm_data_summary$event_type[grep("^tornado", storm_data_summary$event_type)] <- "tornado"

storm_data_summary$event_type[grep("^tropicalstorm", storm_data_summary$event_type)] <- "tropicalstorm"

storm_data_summary$event_type[storm_data_summary$event_type == "unseasonablecold"] <- "unseasonablycold"

storm_data_summary$event_type[storm_data_summary$event_type == "waterspouttornado"] <- "waterspout"

storm_data_summary$event_type[grep("^wildforestfire", storm_data_summary$event_type)] <- "wildfire"
storm_data_summary$event_type[grep("fires$", storm_data_summary$event_type)] <- "wildfire"
storm_data_summary$event_type[storm_data_summary$event_type == "brushfire"] <- "wildfire"

storm_data_summary$event_type[grep("^wind", storm_data_summary$event_type)] <- "wind"

storm_data_summary$event_type[storm_data_summary$event_type == "winterstormhighwinds"] <- "winterstorm"

storm_data_summary$event_type[grep("^winterweather", storm_data_summary$event_type)] <- "winterweather"
storm_data_summary$event_type[storm_data_summary$event_type == "wintrymix"] <- "winterweather"

storm_data_summary <- aggregate(. ~ event_type,
                                data = storm_data_summary,
                                FUN = sum)
```

Things are a bit more clear now. Let's see how these align to the 48 event types
now.

***

```{r sortto48}
storm_data_summary$event_match[storm_data_summary$event_type == "astronomicallowtide"]    <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "avalanche"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "blizzard"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "coastalflood"]           <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "coldwindchill"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "debrisflow"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "densefog"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "densesmoke"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "drought"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "dustdevil"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "duststorm"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "excessiveheat"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "extremecoldwindchill"]   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "flashflood"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "flood"]                  <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "frostfreeze"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "funnelcloud"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "freezingfog"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "hail"]                   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heat"]                   <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heavyrain"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "heavysnow"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "highsurf"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "highwind"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "hurricanetyphoon"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "icestorm"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lakeeffectsnow"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lakeshoreflood"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "lightning"]              <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinehail"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinehighwind"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinestrongwind"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "marinethunderstormwind"] <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "ripcurrent"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "seiche"]                 <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "sleet"]                  <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "stormsurgetide"]         <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "strongwind"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "thunderstormwind"]       <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tornado"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tropicaldepression"]     <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tropicalstorm"]          <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "tsunami"]                <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "volcanicash"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "waterspout"]             <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "wildfire"]               <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "winterstorm"]            <- 1
storm_data_summary$event_match[storm_data_summary$event_type == "winterweather"]          <- 1

final_matching <- aggregate(. ~ event_match,
                            data = storm_data_summary[, -1],
                            FUN = sum)

percent_unmatched_count_final <- final_matching$count[final_matching$event_match == 0] / 
  sum(final_matching$count)

percent_unmatched_injuries_final <- final_matching$injuries[final_matching$event_match == 0] / 
  sum(final_matching$injuries)

percent_unmatched_fatalities_final <- final_matching$fatalities[final_matching$event_match == 0] / 
  sum(final_matching$fatalities)

percent_unmatched_economic_damage_final <- final_matching$economic_damage[final_matching$event_match == 0] / 
  sum(final_matching$economic_damage)

```

After more aggressive remapping, I find that when comparing to the expected 48
event types, I'm unable to match `r percent(percent_unmatched_count_final)`
of the non-zero events, which account for `r percent(percent_unmatched_economic_damage_final)`
of the economic damage, `r percent(percent_unmatched_injuries_final)` of the injuries,
and `r percent(percent_unmatched_fatalities_final)` of the fatalities.

That's an acceptable error rate.

A little text adjustment for the final plotting and analysis section.

``` {r finaltextnaming}
storm_data_summary$event_type[storm_data_summary$event_type == "astronomicallowtide"] <- "Astronomical Low Tide"
storm_data_summary$event_type[storm_data_summary$event_type == "avalanche"] <- "Avalanche"
storm_data_summary$event_type[storm_data_summary$event_type == "blizzard"] <- "Blizzard"
storm_data_summary$event_type[storm_data_summary$event_type == "coastalflood"] <- "Coastal Flood"
storm_data_summary$event_type[storm_data_summary$event_type == "coldwindchill"] <- "Cold/Wind Chill"
storm_data_summary$event_type[storm_data_summary$event_type == "debrisflow"] <- "Debris Flow"
storm_data_summary$event_type[storm_data_summary$event_type == "densefog"] <- "Dense Fog"
storm_data_summary$event_type[storm_data_summary$event_type == "densesmoke"] <- "Dense Smoke"
storm_data_summary$event_type[storm_data_summary$event_type == "drought"] <- "Drought"
storm_data_summary$event_type[storm_data_summary$event_type == "dustdevil"] <- "Dust Devil"
storm_data_summary$event_type[storm_data_summary$event_type == "duststorm"] <- "Dust Storm"
storm_data_summary$event_type[storm_data_summary$event_type == "excessiveheat"] <- "Excessive Heat"
storm_data_summary$event_type[storm_data_summary$event_type == "extremecoldwindchill"] <- "Extreme Cold/Wind Chill"
storm_data_summary$event_type[storm_data_summary$event_type == "flashflood"] <- "Flash Flood"
storm_data_summary$event_type[storm_data_summary$event_type == "flood"] <- "Flood"
storm_data_summary$event_type[storm_data_summary$event_type == "frostfreeze"] <- "Frost/Freeze"
storm_data_summary$event_type[storm_data_summary$event_type == "funnelcloud"] <- "Funnel Cloud"
storm_data_summary$event_type[storm_data_summary$event_type == "freezingfog"] <- "Freezing Fog"
storm_data_summary$event_type[storm_data_summary$event_type == "hail"] <- "Hail"
storm_data_summary$event_type[storm_data_summary$event_type == "heat"] <- "Heat"
storm_data_summary$event_type[storm_data_summary$event_type == "heavyrain"] <- "Heavy Rain"
storm_data_summary$event_type[storm_data_summary$event_type == "heavysnow"] <- "Heavy Snow"
storm_data_summary$event_type[storm_data_summary$event_type == "highsurf"] <- "High Surf"
storm_data_summary$event_type[storm_data_summary$event_type == "highwind"] <- "High Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "hurricanetyphoon"] <- "Hurricane (Typhoon)"
storm_data_summary$event_type[storm_data_summary$event_type == "icestorm"] <- "Ice Storm"
storm_data_summary$event_type[storm_data_summary$event_type == "lakeeffectsnow"] <- "Lake-Effect Snow"
storm_data_summary$event_type[storm_data_summary$event_type == "lakeshoreflood"] <- "Lakeshore Flood"
storm_data_summary$event_type[storm_data_summary$event_type == "lightning"] <- "Lightning"
storm_data_summary$event_type[storm_data_summary$event_type == "marinehail"] <- "Marine Hail"
storm_data_summary$event_type[storm_data_summary$event_type == "marinehighwind"] <- "Marine High Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "marinestrongwind"] <- "Marine Strong Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "marinethunderstormwind"] <- "Marine Thunderstorm Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "ripcurrent"] <- "Rip Current"
storm_data_summary$event_type[storm_data_summary$event_type == "seiche"] <- "Seiche"
storm_data_summary$event_type[storm_data_summary$event_type == "sleet"] <- "Sleet"
storm_data_summary$event_type[storm_data_summary$event_type == "stormsurgetide"] <- "Storm Surge/Tide"
storm_data_summary$event_type[storm_data_summary$event_type == "strongwind"] <- "Strong Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "thunderstormwind"] <- "Thunderstorm Wind"
storm_data_summary$event_type[storm_data_summary$event_type == "tornado"] <- "Tornado"
storm_data_summary$event_type[storm_data_summary$event_type == "tropicaldepression"] <- "Tropical Depression"
storm_data_summary$event_type[storm_data_summary$event_type == "tropicalstorm"] <- "Tropical Storm"
storm_data_summary$event_type[storm_data_summary$event_type == "tsunami"] <- "Tsunami"
storm_data_summary$event_type[storm_data_summary$event_type == "volcanicash"] <- "Volcanic Ash"
storm_data_summary$event_type[storm_data_summary$event_type == "waterspout"] <- "Waterspout"
storm_data_summary$event_type[storm_data_summary$event_type == "wildfire"] <- "Wildfire"
storm_data_summary$event_type[storm_data_summary$event_type == "winterstorm"] <- "Winter Storm"
storm_data_summary$event_type[storm_data_summary$event_type == "winterweather"] <- "Winter Weather"
```

***

# Results

## Top 20 Fatality, Injury, and Economic Damage Sources

I will determine the top 20 event types for causing fatalities + injuries and 
separately for causing economic damage.